<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ - ‡πÅ‡∏¢‡∏Å‡∏´‡∏ô‡πâ‡∏≤</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .cursor-none { cursor: none; }
        .text-shadow-lg { text-shadow: 0 4px 12px rgba(0,0,0,0.8); }
        .glass-effect { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .admin-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .progress-bar-fill { transition: width 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Firebase Modules ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-storage.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDadMZYr6lioUdc894l7PZzt6dxs8Ep_gw",
            authDomain: "test-318d9.firebaseapp.com",
            projectId: "test-318d9",
            storageBucket: "test-318d9.firebasestorage.app",
            messagingSenderId: "313725009474",
            appId: "1:313725009474:web:42d018f2b4a4ae2c1977db",
            measurementId: "G-0J344393JS"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'photo-queue-v1';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const SETTINGS_COLLECTION = ['artifacts', appId, 'public', 'data', 'settings'];
        const QUEUE_COLLECTION = ['artifacts', appId, 'public', 'data', 'queue'];

        // --- SVG Icons ---
        const Icons = {
            Monitor: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
            Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Image: () => <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Link: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
        };

        // --- View: Customer ---
        const CustomerView = ({ config, user }) => {
            const [formData, setFormData] = useState({ name: '', message: '' });
            const [selectedFile, setSelectedFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState('');
            const [status, setStatus] = useState(null);
            const [uploadProgress, setUploadProgress] = useState(0);
            const [uploading, setUploading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!selectedFile || !user) return;
                
                setUploading(true);
                setUploadProgress(0);

                try {
                    // 1. Upload to Storage first (to handle large files up to 10MB)
                    const fileExt = selectedFile.name.split('.').pop();
                    const fileName = `${user.uid}_${Date.now()}.${fileExt}`;
                    const storagePath = `artifacts/${appId}/uploads/${fileName}`;
                    const storageRef = ref(storage, storagePath);
                    
                    const uploadTask = uploadBytesResumable(storageRef, selectedFile);

                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            setUploadProgress(Math.round(progress));
                        }, 
                        (error) => {
                            console.error("Upload error:", error);
                            setStatus('error');
                            setUploading(false);
                        }, 
                        async () => {
                            // Upload finished
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            
                            // 2. Add to Firestore with the Storage URL
                            await addDoc(collection(db, ...QUEUE_COLLECTION), {
                                name: formData.name,
                                message: formData.message,
                                imageUrl: downloadURL,
                                status: 'pending',
                                createdAt: serverTimestamp(),
                                userId: user.uid
                            });

                            setStatus('success');
                            setFormData({ name: '', message: '' });
                            setSelectedFile(null);
                            setPreviewUrl('');
                            setUploading(false);
                            setTimeout(() => setStatus(null), 5000);
                        }
                    );

                } catch (err) {
                    console.error("Submit error:", err);
                    setStatus('error');
                    setUploading(false);
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 10 * 1024 * 1024) {
                        alert("‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏à‡∏≥‡∏Å‡∏±‡∏î 10MB)");
                        return;
                    }
                    setSelectedFile(file);
                    const reader = new FileReader();
                    reader.onloadend = () => setPreviewUrl(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="max-w-md mx-auto p-6 pt-12">
                    <div className="text-center mb-10">
                        <div className="inline-block p-4 rounded-3xl bg-blue-600/20 mb-4 border border-blue-500/20 shadow-xl">
                            <Icons.Image />
                        </div>
                        <h1 className="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 mb-2">{config.title}</h1>
                        <p className="opacity-50">‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10MB)</p>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="relative group">
                            <div className={`w-full h-72 border-2 border-dashed rounded-3xl flex flex-col items-center justify-center overflow-hidden transition-all duration-300 ${previewUrl ? 'border-blue-500 bg-blue-500/5 shadow-2xl scale-105' : 'border-white/10 bg-white/5 hover:border-white/30'}`}>
                                {previewUrl ? (
                                    <div className="relative w-full h-full">
                                        <img src={previewUrl} className="w-full h-full object-cover" alt="Preview" />
                                        {uploading && (
                                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm flex flex-col items-center justify-center p-6">
                                                <div className="w-full bg-white/20 h-3 rounded-full overflow-hidden mb-4">
                                                    <div 
                                                        className="progress-bar-fill bg-blue-500 h-full" 
                                                        style={{ width: `${uploadProgress}%` }}
                                                    ></div>
                                                </div>
                                                <p className="text-xl font-black text-white">{uploadProgress}%</p>
                                                <p className="text-sm text-blue-300 font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...</p>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center p-8 space-y-4">
                                        <div className="text-blue-400/50 mx-auto flex justify-center"><Icons.Upload /></div>
                                        <p className="text-sm opacity-40 font-bold uppercase tracking-widest">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
                                    </div>
                                )}
                                <input disabled={uploading} type="file" accept="image/*" onChange={handleFileChange} className="absolute inset-0 opacity-0 cursor-pointer" />
                            </div>
                            {previewUrl && !uploading && (
                                <button type="button" onClick={() => {setPreviewUrl(''); setSelectedFile(null);}} className="absolute top-4 right-4 bg-red-500 p-2 rounded-full shadow-2xl hover:scale-110 transition">
                                    <Icons.X />
                                </button>
                            )}
                        </div>

                        <div className="space-y-4">
                            <input disabled={uploading} required type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all disabled:opacity-50" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." />
                            <textarea disabled={uploading} value={formData.message} onChange={e => setFormData({...formData, message: e.target.value})} className="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all disabled:opacity-50" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..." rows="3" />
                        </div>

                        <button disabled={uploading || !selectedFile} className={`w-full py-5 rounded-3xl font-black text-xl flex items-center justify-center gap-3 shadow-2xl transition-all active:scale-95 ${uploading || !selectedFile ? 'bg-slate-800 text-white/30' : 'bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 shadow-blue-500/20'}`}>
                            {uploading ? `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ${uploadProgress}%` : <><Icons.Upload /> ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</>}
                        </button>

                        {status === 'success' && (
                            <div className="bg-green-500/10 border border-green-500/30 text-green-400 p-5 rounded-2xl text-center animate-bounce">
                                <p className="font-bold">‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üöÄ</p>
                                <p className="text-xs opacity-70">‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</p>
                            </div>
                        )}
                        {status === 'error' && (
                            <div className="bg-red-500/10 border border-red-500/30 text-red-400 p-5 rounded-2xl text-center">
                                <p className="font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‚ùå</p>
                                <p className="text-xs opacity-70">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                            </div>
                        )}
                    </form>
                </div>
            );
        };

        // --- View: Admin ---
        const AdminView = ({ config, queue }) => {
            const [activeTab, setActiveTab] = useState('queue');
            const [copyStatus, setCopyStatus] = useState(null);

            const updateConfig = (key, value) => { setDoc(doc(db, ...SETTINGS_COLLECTION, 'main'), { ...config, [key]: value }); };
            const updateStatus = (id, status) => { updateDoc(doc(db, ...QUEUE_COLLECTION, id), { status }); };
            const deleteItem = (id) => { deleteDoc(doc(db, ...QUEUE_COLLECTION, id)); };

            const clearAllData = async () => {
                if (window.confirm("‚ùó ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß (‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    const snapshot = await getDocs(collection(db, ...QUEUE_COLLECTION));
                    snapshot.forEach((d) => deleteDoc(d.ref));
                }
            };

            const pending = queue.filter(i => i.status === 'pending');
            
            // Sync current item to top of approved list
            const approved = useMemo(() => {
                const list = queue.filter(i => i.status === 'approved');
                if (list.length === 0) return [];
                const currentIndex = config.currentIndex || 0;
                const safeIndex = currentIndex % list.length;
                const activeItem = list[safeIndex];
                
                // Sort: Current item first, then the rest
                const others = list.filter(item => item.id !== activeItem?.id);
                return activeItem ? [activeItem, ...others] : list;
            }, [queue, config.currentIndex]);

            const copyLink = (param) => {
                const url = window.location.origin + window.location.pathname + (param ? `?view=${param}` : '');
                const dummy = document.createElement("input");
                document.body.appendChild(dummy);
                dummy.value = url;
                dummy.select();
                document.execCommand("copy");
                document.body.removeChild(dummy);
                setCopyStatus(param || 'customer');
                setTimeout(() => setCopyStatus(null), 2000);
            };

            return (
                <div className="max-w-6xl mx-auto p-6 pb-40">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                        <div>
                            <h1 className="text-3xl font-black text-white flex items-center gap-3">
                                <div className="p-2 bg-purple-600 rounded-xl"><Icons.Settings /></div>
                                ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                            </h1>
                            <p className="opacity-40 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={clearAllData} className="px-5 py-3 rounded-2xl bg-red-500/10 border border-red-500/20 text-red-500 text-sm font-bold hover:bg-red-500 hover:text-white transition-all flex items-center gap-2">
                                <Icons.Trash /> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                        </div>
                    </header>

                    <div className="flex gap-4 mb-8 bg-white/5 p-1.5 rounded-2xl inline-flex">
                        <button onClick={() => setActiveTab('queue')} className={`px-6 py-3 rounded-xl transition-all font-bold text-sm ${activeTab === 'queue' ? 'bg-white/10 shadow-lg text-white' : 'opacity-40'}`}>
                            ‡∏Ñ‡∏¥‡∏ß‡∏†‡∏≤‡∏û ({pending.length})
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`px-6 py-3 rounded-xl transition-all font-bold text-sm ${activeTab === 'settings' ? 'bg-white/10 shadow-lg text-white' : 'opacity-40'}`}>
                            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>

                    {activeTab === 'queue' ? (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                            {/* Pending Section */}
                            <section className="space-y-6">
                                <div className="flex items-center gap-3 border-b border-white/5 pb-4">
                                    <div className="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                                    <h2 className="text-xl font-bold">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {pending.map(item => (
                                        <div key={item.id} className="bg-white/5 border border-white/10 rounded-3xl overflow-hidden group">
                                            <div className="h-44 relative">
                                                <img src={item.imageUrl} className="w-full h-full object-cover" alt="" />
                                                <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center gap-4">
                                                    <button onClick={() => updateStatus(item.id, 'approved')} className="p-3 bg-green-500 rounded-2xl shadow-xl hover:scale-110 transition"><Icons.Check /></button>
                                                    <button onClick={() => deleteItem(item.id)} className="p-3 bg-red-500 rounded-2xl shadow-xl hover:scale-110 transition"><Icons.Trash /></button>
                                                </div>
                                            </div>
                                            <div className="p-4 bg-white/[0.02]">
                                                <p className="font-bold text-sm truncate">{item.name}</p>
                                                <p className="text-xs opacity-40 line-clamp-1">{item.message || '-'}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {pending.length === 0 && <div className="col-span-full py-10 text-center opacity-20 italic bg-white/5 rounded-3xl border border-dashed border-white/10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>}
                                </div>
                            </section>

                            {/* Approved Section */}
                            <section className="space-y-6">
                                <div className="flex items-center gap-3 border-b border-white/5 pb-4">
                                    <div className="w-2 h-2 rounded-full bg-green-500"></div>
                                    <h2 className="text-xl font-bold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ô‡∏†‡∏≤‡∏û)</h2>
                                </div>
                                <div className="space-y-3 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                                    {approved.map((item, idx) => (
                                        <div key={item.id} className={`flex items-center gap-4 p-4 rounded-3xl border transition-all ${idx === 0 ? 'bg-blue-600/20 border-blue-500/50 shadow-lg shadow-blue-500/10' : 'bg-white/5 border-white/10'}`}>
                                            <div className="relative">
                                                <img src={item.imageUrl} className="w-20 h-20 rounded-2xl object-cover shadow-lg" />
                                                {idx === 0 && <div className="absolute -top-2 -left-2 bg-blue-500 text-[10px] font-black px-2 py-1 rounded-lg animate-bounce">NOW</div>}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <p className="font-bold text-lg truncate">{item.name}</p>
                                                <p className="text-sm opacity-50 truncate italic">"{item.message || '...'}"</p>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => updateStatus(item.id, 'pending')} className="p-2.5 text-yellow-500 hover:bg-yellow-500/10 rounded-xl transition"><Icons.X /></button>
                                                <button onClick={() => deleteItem(item.id)} className="p-2.5 text-red-500 hover:bg-red-500/10 rounded-xl transition"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    ))}
                                    {approved.length === 0 && <div className="py-10 text-center opacity-20 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</div>}
                                </div>
                            </section>
                        </div>
                    ) : (
                        <div className="bg-white/5 border border-white/10 rounded-3xl p-10 max-w-2xl mx-auto space-y-10">
                            <div className="space-y-6">
                                <h3 className="text-xl font-bold text-blue-400">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</h3>
                                <div><label className="block text-sm opacity-40 mb-2 font-bold uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Title)</label><input type="text" value={config.title} onChange={e => updateConfig('title', e.target.value)} className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all" /></div>
                            </div>
                            <div className="space-y-6 pt-10 border-t border-white/5">
                                <h3 className="text-xl font-bold text-blue-400">‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-8">
                                    <div><label className="block text-sm opacity-40 mb-2 font-bold uppercase tracking-wider">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡πÑ‡∏•‡∏î‡πå (ms)</label><input type="number" step="500" value={config.transitionSpeed} onChange={e => updateConfig('transitionSpeed', parseInt(e.target.value) || 5000)} className="w-full bg-black/40 border border-white/10 rounded-2xl px-5 py-3 outline-none" /></div>
                                    <div className="flex items-center gap-4 bg-black/20 p-4 rounded-2xl border border-white/5">
                                        <input type="checkbox" checked={config.autoPlay} onChange={e => updateConfig('autoPlay', e.target.checked)} className="w-6 h-6 accent-blue-500 cursor-pointer" id="autoplay-check" />
                                        <label htmlFor="autoplay-check" className="font-bold cursor-pointer">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Quick Link Switcher at bottom */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 glass-effect p-3 rounded-3xl border border-white/20 flex gap-4 shadow-2xl z-50">
                        <button onClick={() => copyLink('')} className="flex items-center gap-2 px-4 py-2 hover:bg-white/10 rounded-2xl transition text-xs font-bold uppercase tracking-widest">
                            <Icons.Link /> {copyStatus === 'customer' ? 'COPIED!' : 'Copy Customer Link'}
                        </button>
                        <div className="w-px bg-white/10"></div>
                        <button onClick={() => copyLink('display')} className="flex items-center gap-2 px-4 py-2 hover:bg-white/10 rounded-2xl transition text-xs font-bold uppercase tracking-widest">
                            <Icons.Link /> {copyStatus === 'display' ? 'COPIED!' : 'Copy Display Link'}
                        </button>
                        <div className="w-px bg-white/10"></div>
                        <button onClick={() => copyLink('admin')} className="flex items-center gap-2 px-4 py-2 hover:bg-white/10 rounded-2xl transition text-xs font-bold uppercase tracking-widest">
                            <Icons.Link /> {copyStatus === 'admin' ? 'COPIED!' : 'Copy Admin Link'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- View: Display ---
        const DisplayView = ({ config, queue, setView }) => {
            const [localIndex, setLocalIndex] = useState(0);
            const [isTransitioning, setIsTransitioning] = useState(false);
            const approvedItems = queue.filter(i => i.status === 'approved');

            useEffect(() => {
                if (config.autoPlay && approvedItems.length > 1) {
                    const t = setInterval(() => {
                        handleNext();
                    }, config.transitionSpeed);
                    return () => clearInterval(t);
                }
            }, [config.autoPlay, config.transitionSpeed, approvedItems.length]);

            const handleNext = async () => {
                setIsTransitioning(true);
                setTimeout(async () => {
                    const nextIndex = (localIndex + 1) % approvedItems.length;
                    setLocalIndex(nextIndex);
                    setIsTransitioning(false);
                    // Sync current index to Firebase for Admin sorting
                    await updateDoc(doc(db, ...SETTINGS_COLLECTION, 'main'), { currentIndex: nextIndex });
                }, 600);
            };

            if (approvedItems.length === 0) return (
                <div className="h-screen flex flex-col items-center justify-center text-center p-12 bg-slate-950">
                    <h1 className="text-8xl font-black mb-10 animate-pulse bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">{config.title}</h1>
                    <div className="bg-white/5 p-16 rounded-[4rem] border border-white/10 backdrop-blur-3xl shadow-2xl">
                        <div className="text-blue-500/30 flex justify-center mb-6 scale-150"><Icons.Image /></div>
                        <p className="text-3xl font-bold opacity-30">Waiting for first photo...</p>
                    </div>
                </div>
            );

            // Safety check for index out of bounds (e.g. after multiple deletions)
            const safeIdx = localIndex >= approvedItems.length ? 0 : localIndex;
            const item = approvedItems[safeIdx];

            return (
                <div className="h-screen w-screen bg-black flex flex-col relative overflow-hidden cursor-none">
                    <div className="absolute inset-0 blur-[150px] opacity-40 scale-150 transition-all duration-1000" style={{backgroundImage: `url(${item.imageUrl})`, backgroundSize: 'cover', backgroundPosition: 'center'}}></div>
                    
                    <div className="absolute top-0 w-full p-12 flex justify-between items-start z-20">
                        <div className="space-y-2">
                            <h2 className="text-6xl font-black italic tracking-tighter text-shadow-lg text-white/95">{config.title}</h2>
                            <div className="flex items-center gap-3">
                                <div className="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                                <p className="text-blue-400 font-black tracking-[0.4em] uppercase text-lg opacity-90">LIVE PHOTO STREAM</p>
                            </div>
                        </div>
                        <div className="text-5xl font-mono font-extralight text-white/40 tracking-tighter drop-shadow-2xl">
                            <LiveTime />
                        </div>
                    </div>

                    <div className={`flex-1 flex items-center justify-center p-20 z-10 transition-all duration-1000 transform ${isTransitioning ? 'opacity-0 scale-90 blur-2xl rotate-2' : 'opacity-100 scale-100 blur-0 rotate-0'}`}>
                        <div className="relative">
                            <div className="absolute -inset-10 bg-blue-500/10 blur-[100px] rounded-full animate-pulse"></div>
                            <img src={item.imageUrl} className="max-w-full max-h-[70vh] object-contain rounded-[2.5rem] shadow-[0_40px_100px_-20px_rgba(0,0,0,1)] border-4 border-white/5" />
                        </div>
                    </div>

                    <div className={`glass-effect w-full p-12 md:p-16 z-20 flex items-center gap-14 transition-all duration-1000 ${isTransitioning ? 'translate-y-40 opacity-0' : 'translate-y-0 opacity-100'}`}>
                        <div className="w-28 h-28 rounded-[2rem] bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center text-5xl font-black shadow-2xl flex-shrink-0 text-white transform rotate-3">
                            {item.name ? item.name[0].toUpperCase() : '?'}
                        </div>
                        <div className="flex-1 space-y-3">
                            <div className="flex items-center gap-6">
                                <h3 className="text-7xl font-black text-white text-shadow-lg tracking-tight">{item.name}</h3>
                            </div>
                            <p className="text-4xl text-white/70 italic font-light tracking-wide line-clamp-1 leading-relaxed">
                                {item.message ? `"${item.message}"` : "Enjoying the moment together"}
                            </p>
                        </div>
                        <div className="hidden xl:flex border-l border-white/10 pl-14 items-center gap-8">
                            <div className="text-right">
                                <p className="text-sm uppercase tracking-[0.5em] opacity-30 font-black mb-1">Join Now</p>
                                <p className="text-xl font-bold text-blue-400">Scan QR to Send</p>
                            </div>
                            <div className="w-24 h-24 bg-white rounded-3xl p-1.5 flex items-center justify-center shadow-2xl">
                                <div className="text-black text-[10px] font-black text-center leading-tight">SCAN<br/>ME</div>
                            </div>
                        </div>
                    </div>

                    <div className="absolute bottom-0 left-0 h-2 bg-gradient-to-r from-blue-600 to-purple-600 z-30" style={{
                        width: '100%', 
                        transform: `scaleX(${isTransitioning ? 0 : 1})`, 
                        transformOrigin: 'left', 
                        transition: isTransitioning ? 'none' : `transform ${config.transitionSpeed}ms linear`
                    }}></div>
                </div>
            );
        };

        // --- Main Controller ---
        const App = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view') || 'customer';
            
            const [user, setUser] = useState(null);
            const [config, setConfig] = useState({ title: "Welcome", transitionSpeed: 5000, autoPlay: true, theme: 'dark', currentIndex: 0 });
            const [queue, setQueue] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await signInWithCustomToken(auth, __initial_auth_token); } 
                            catch (e) { await signInAnonymously(auth); }
                        } else { await signInAnonymously(auth); }
                    } catch (e) { console.error(e); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubConfig = onSnapshot(doc(db, ...SETTINGS_COLLECTION, 'main'), (s) => {
                    if (s.exists()) setConfig(s.data());
                    else setDoc(doc(db, ...SETTINGS_COLLECTION, 'main'), config);
                });
                const unsubQueue = onSnapshot(collection(db, ...QUEUE_COLLECTION), (s) => {
                    setQueue(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
                });
                return () => { unsubConfig(); unsubQueue(); };
            }, [user]);

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-950">
                    <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6 shadow-2xl shadow-blue-500/20"></div>
                    <p className="text-blue-500 font-black tracking-[0.3em] uppercase text-xs animate-pulse">Initializing System...</p>
                </div>
            );

            return (
                <div className="min-h-screen selection:bg-blue-500 selection:text-white">
                    {viewParam === 'admin' && <AdminView config={config} queue={queue} />}
                    {viewParam === 'display' && <DisplayView config={config} queue={queue} />}
                    {viewParam === 'customer' && <CustomerView config={config} user={user} />}
                </div>
            );
        };

        const LiveTime = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return time.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
