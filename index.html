<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- ล็อกไม่ให้ซูมหน้าเว็บ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty Premium - Modal System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: #f8fafc;
            /* ป้องกันการเลือกข้อความและการลากเพื่อซูมในบางเบราว์เซอร์ */
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            user-select: none;
        }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tier-silver { background: linear-gradient(135deg, #94a3b8, #475569); }
        .tier-gold { background: linear-gradient(135deg, #fbbf24, #b45309); }
        .tier-platinum { background: linear-gradient(135deg, #818cf8, #4338ca); }

        .floating-nav {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 48px);
            max-width: 420px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 28px;
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.15);
            z-index: 45;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }
        
        @media (min-width: 640px) {
            .modal-overlay { align-items: center; }
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 450px;
            border-radius: 32px 32px 0 0;
            padding: 28px;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @media (min-width: 640px) {
            .modal-content { border-radius: 32px; transform: scale(0.9); opacity: 0; }
        }

        .modal-active .modal-content { transform: translateY(0); }
        @media (min-width: 640px) {
            .modal-active .modal-content { transform: scale(1); opacity: 1; }
        }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .otp-input:focus { letter-spacing: 0.5rem; }
        
        button:active { transform: scale(0.95); }
    </style>
</head>
<body class="text-slate-900 overflow-x-hidden">

    <div id="app" class="min-h-screen flex flex-col max-w-md mx-auto bg-white shadow-2xl overflow-hidden relative pb-32">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-white z-[120] flex items-center justify-center max-w-md mx-auto">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-indigo-600 border-r-transparent mx-auto mb-4"></div>
                <p class="text-sm font-bold text-slate-400 tracking-widest uppercase">Connecting...</p>
            </div>
        </div>

        <!-- Top Header -->
        <header id="app-header" class="hidden px-6 py-5 flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur-md z-40 border-b border-slate-50">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-xl text-white shadow-indigo-200 shadow-xl">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 id="nav-store-name" class="font-black text-lg text-slate-800 truncate leading-none text-left">Store</h1>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Loyalty Member</p>
                </div>
            </div>
            <div class="bg-slate-100 p-1 rounded-full flex scale-90">
                <button onclick="switchRole('customer')" id="role-cust" class="px-4 py-1.5 rounded-full text-[10px] font-black transition-all">USER</button>
                <button onclick="switchRole('admin')" id="role-admin" class="px-4 py-1.5 rounded-full text-[10px] font-black transition-all">ADMIN</button>
            </div>
        </header>

        <!-- Main View Container -->
        <main id="main-content" class="flex-grow p-6 space-y-8 min-h-screen">
            <!-- Dynamic components will load here -->
        </main>

        <!-- Floating Navigation Bar -->
        <nav id="bottom-nav" class="hidden floating-nav px-3 py-2 flex justify-around items-center">
            <!-- Navigation buttons populated by JS -->
        </nav>

        <!-- Popups / Modals Wrapper -->
        <div id="modal-overlay" class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-content shadow-2xl relative" onclick="event.stopPropagation()">
                <!-- Close Button -->
                <button onclick="closeModal()" class="absolute top-6 right-6 p-2 bg-slate-50 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                
                <h3 id="modal-title" class="text-2xl font-black text-slate-800 mb-6 pr-10">Title</h3>
                
                <div id="modal-body" class="max-h-[75vh] overflow-y-auto hide-scroll pb-4">
                    <!-- Modal content dynamic -->
                </div>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notif" class="fixed top-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[380px] z-[130] pointer-events-none space-y-3"></div>
        
        <!-- Firebase Recaptcha -->
        <div id="recaptcha-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot, serverTimestamp, runTransaction, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const userProvidedConfig = {
            apiKey: "AIzaSyDadMZYr6lioUdc894l7PZzt6dxs8Ep_gw",
            authDomain: "test-318d9.firebaseapp.com",
            projectId: "test-318d9",
            storageBucket: "test-318d9.firebasestorage.app",
            messagingSenderId: "313725009474",
            appId: "1:313725009474:web:42d018f2b4a4ae2c1977db",
            measurementId: "G-0J344393JS"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        const finalAppId = typeof __app_id !== 'undefined' ? __app_id : 'loyalty-v4-popups';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let state = {
            user: null,
            role: 'customer',
            view: 'dashboard',
            userData: null,
            config: { storeName: 'Premium Rewards', multiplier: 1, branches: ['Siam Square', 'Central World'] },
            rewards: [],
            transactions: [],
            allCustomers: [],
            coupons: [],
            activeQr: null,
            confirmationResult: null,
            tempPhone: ''
        };

        // --- Utility Functions ---
        const refreshIcons = () => {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        };
        
        const showMsg = (text, type = 'success') => {
            const container = document.getElementById('notif');
            if (!container) return;
            const id = 'm' + Date.now();
            const bg = type === 'error' ? 'bg-rose-500' : 'bg-slate-900';
            container.innerHTML += `<div id="${id}" class="${bg} text-white px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-3 animate-in text-sm font-bold border border-white/10">
                <i data-lucide="${type === 'error' ? 'alert-circle' : 'check-circle'}" class="w-4 h-4"></i> ${text}
            </div>`;
            refreshIcons();
            setTimeout(() => document.getElementById(id)?.remove(), 4000);
        };

        window.openModal = (title, bodyHtml) => {
            const overlay = document.getElementById('modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const bodyEl = document.getElementById('modal-body');
            
            if (!overlay || !titleEl || !bodyEl) return;
            
            titleEl.innerText = title;
            bodyEl.innerHTML = bodyHtml;
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('modal-active'), 10);
            refreshIcons();
        };

        window.closeModal = (e) => {
            const overlay = document.getElementById('modal-overlay');
            if (!overlay) return;
            overlay.classList.remove('modal-active');
            setTimeout(() => overlay.style.display = 'none', 350);
        };

        const getTier = (pts) => {
            if (pts >= 5000) return { name: 'Platinum', class: 'tier-platinum', icon: 'zap' };
            if (pts >= 1000) return { name: 'Gold', class: 'tier-gold', icon: 'star' };
            return { name: 'Silver', class: 'tier-silver', icon: 'shield' };
        };

        // --- Auth Actions ---

        window.requestOtpPopup = () => {
            openModal("เข้าสู่ระบบสมาชิก", `
                <div class="space-y-6">
                    <div class="space-y-4">
                        <div class="space-y-1 text-left">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">เบอร์โทรศัพท์</label>
                            <input id="login-phone" type="tel" placeholder="08XXXXXXXX" class="w-full p-5 rounded-3xl bg-slate-50 border-none outline-none font-black text-center text-xl focus:ring-4 focus:ring-indigo-50 transition-all" />
                        </div>
                        <div class="space-y-1 text-left">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">ชื่อที่ใช้แสดงผล</label>
                            <input id="login-name" type="text" placeholder="ชื่อเล่น" class="w-full p-5 rounded-3xl bg-slate-50 border-none outline-none font-bold text-center text-lg focus:ring-4 focus:ring-indigo-50 transition-all" />
                        </div>
                        <button onclick="handleRequestOtp()" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-2xl shadow-indigo-100 hover:bg-indigo-700 mt-4">ขอรหัสยืนยัน OTP</button>
                    </div>
                    <p class="text-[10px] text-center text-slate-400 font-medium">ระบบจะส่งรหัสผ่านทาง SMS เพื่อความปลอดภัยสูงสุด</p>
                </div>
            `);
        };

        window.handleRequestOtp = async () => {
            const phone = document.getElementById('login-phone').value;
            const name = document.getElementById('login-name').value;
            if (!phone || phone.length < 10) return showMsg("กรุณาระบุเบอร์โทรให้ถูกต้อง", "error");
            
            let formattedPhone = phone.startsWith('0') ? '+66' + phone.substring(1) : phone;
            try {
                if (!window.recaptchaVerifier) window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
                state.tempPhone = phone;
                state.confirmationResult = await signInWithPhoneNumber(auth, formattedPhone, window.recaptchaVerifier);
                showMsg("รหัส OTP ถูกส่งแล้ว");
                openModal("ยืนยันรหัส OTP", `
                    <div class="space-y-6 text-center">
                        <p class="text-slate-500 font-medium text-sm">กรอกรหัส 6 หลักที่ได้รับทางเบอร์<br><span class="text-indigo-600 font-black">${phone}</span></p>
                        <input id="login-otp" type="number" placeholder="XXXXXX" class="w-full p-6 rounded-3xl bg-slate-50 border-none outline-none font-black text-center text-3xl tracking-[1.2rem] otp-input focus:ring-4 focus:ring-emerald-50" />
                        <button onclick="handleVerifyOtp('${name}')" class="w-full bg-emerald-600 text-white py-5 rounded-3xl font-black shadow-2xl shadow-emerald-100">ตรวจสอบและเข้าใช้งาน</button>
                        <button onclick="requestOtpPopup()" class="text-slate-400 font-bold text-xs">ขอรหัสใหม่หรือเปลี่ยนเบอร์</button>
                    </div>
                `);
            } catch (e) { 
                showMsg("ล้มเหลว: " + e.message, "error"); 
                if (window.recaptchaVerifier) window.recaptchaVerifier.clear(); 
            }
        };

        window.handleVerifyOtp = async (name) => {
            const code = document.getElementById('login-otp').value;
            if (!code || code.length !== 6) return showMsg("ระบุรหัส 6 หลัก", "error");
            try {
                const result = await state.confirmationResult.confirm(code);
                const user = result.user;
                const userRef = doc(db, 'artifacts', finalAppId, 'public', 'data', 'users', user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, { 
                        uid: user.uid, phone: state.tempPhone, name: name || 'Anonymous', 
                        points: 0, totalPointsEarned: 0, role: 'customer', createdAt: serverTimestamp() 
                    });
                }
                closeModal();
                showMsg("ยินดีต้อนรับครับ!");
            } catch (e) { showMsg("รหัสยืนยันไม่ถูกต้อง", "error"); }
        };

        window.handleLogout = async () => { await signOut(auth); location.reload(); };

        // --- Admin Actions ---

        window.openGivePointsModal = () => {
            openModal("ออกแต้มสะสม", `
                <div class="space-y-8 text-center pt-2">
                    <div class="bg-indigo-50 w-24 h-24 rounded-[2rem] flex items-center justify-center mx-auto text-indigo-600 shadow-inner ring-8 ring-indigo-50/50">
                        <i data-lucide="qr-code" class="w-12 h-12"></i>
                    </div>
                    <div class="space-y-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ระบุจำนวนแต้มเบื้องต้น</label>
                        <input id="admin-pts-input" type="number" value="10" class="w-full text-6xl text-center font-black text-indigo-600 bg-transparent outline-none focus:ring-0" />
                        <div class="bg-indigo-50 py-2 px-4 rounded-full inline-block">
                            <span class="text-[10px] font-black text-indigo-400 uppercase">คูณ X${state.config.multiplier} = </span>
                            <span id="pts-preview" class="text-sm font-black text-indigo-600">${10 * state.config.multiplier} แต้ม</span>
                        </div>
                    </div>
                    <button onclick="handleGenerateQr()" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-2xl shadow-indigo-100 hover:scale-[1.02] transition-all">สร้าง QR Code สแกนรับแต้ม</button>
                </div>
            `);
            const input = document.getElementById('admin-pts-input');
            input.addEventListener('input', () => {
                document.getElementById('pts-preview').innerText = (parseInt(input.value || 0) * state.config.multiplier) + " แต้ม";
            });
        };

        window.handleGenerateQr = async () => {
            const pts = document.getElementById('admin-pts-input').value;
            const finalPts = parseInt(pts) * state.config.multiplier;
            try {
                const docRef = await addDoc(collection(db, 'artifacts', finalAppId, 'public', 'data', 'qr_tokens'), {
                    points: finalPts, status: 'active', createdAt: serverTimestamp()
                });
                const url = `${window.location.origin}${window.location.pathname}?token=${docRef.id}`;
                openModal("สแกนเพื่อรับแต้ม", `
                    <div class="flex flex-col items-center gap-6 p-4 text-center">
                        <div class="space-y-1">
                            <h4 class="font-black text-4xl text-indigo-600">${finalPts}</h4>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">สะสมเพิ่มทันที</p>
                        </div>
                        <div id="modal-qrcode" class="p-6 bg-white rounded-[3rem] shadow-inner border border-slate-50 ring-1 ring-slate-100"></div>
                        <p class="text-[9px] text-slate-400 font-mono break-all leading-relaxed px-4">${url}</p>
                        <button onclick="closeModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black mt-4 shadow-xl">เสร็จสิ้น</button>
                    </div>
                `);
                new QRCode(document.getElementById("modal-qrcode"), { text: url, width: 200, height: 200, colorDark: "#4f46e5" });
            } catch (e) { showMsg("ระบบไม่สามารถสร้าง QR ได้", "error"); }
        };

        window.openVerifyCouponModal = () => {
            openModal("ยืนยันคูปองรางวัล", `
                <div class="space-y-6">
                    <p class="text-center text-slate-500 text-sm font-medium">ให้ลูกค้ายื่นหน้าคูปองที่มีรหัส 6 หลัก<br>แล้วกรอกรหัสลงในช่องด้านล่าง</p>
                    <input id="verify-code-input" placeholder="รหัสคูปอง" class="w-full p-5 rounded-3xl bg-slate-50 border-none text-center font-black text-4xl uppercase tracking-tighter outline-none focus:ring-4 focus:ring-indigo-50" maxlength="6" />
                    <button onclick="handleVerifyCoupon()" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black shadow-2xl">ยืนยันและหักสิทธิ์</button>
                </div>
            `);
        };

        window.handleVerifyCoupon = async () => {
            const code = document.getElementById('verify-code-input').value.toUpperCase();
            const q = state.coupons.find(c => c.code === code && c.status === 'active');
            if (!q) return showMsg("ไม่พบรหัส หรือคูปองถูกใช้ไปแล้ว", "error");
            try {
                await updateDoc(doc(db, 'artifacts', finalAppId, 'public', 'data', 'coupons', q.id), { status: 'used', verifiedAt: serverTimestamp() });
                showMsg("ยืนยันสิทธิ์รางวัลสำเร็จ!");
                closeModal();
            } catch (e) { showMsg("บันทึกข้อมูลล้มเหลว", "error"); }
        };

        window.openSettingsModal = () => {
            openModal("ตั้งค่าร้านค้า", `
                <div class="space-y-8 pb-4">
                    <div class="space-y-6">
                        <div class="space-y-2 text-left">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-2">ชื่อร้านค้าที่ลูกค้าเห็น</label>
                            <input id="set-store-name" value="${state.config.storeName}" class="w-full p-4 rounded-2xl bg-slate-50 border-none font-bold outline-none focus:ring-4 focus:ring-indigo-50" />
                        </div>
                        <div class="space-y-2 text-left">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-2">แต้มคูณ (Rule Engine)</label>
                            <div class="flex gap-3">
                                ${[1,2,3].map(m => `<button onclick="handleSaveRule(${m})" class="flex-1 py-4 rounded-2xl border-2 transition-all font-black ${state.config.multiplier === m ? 'border-indigo-600 bg-indigo-600 text-white shadow-lg' : 'border-slate-100 text-slate-400'}">X${m}</button>`).join('')}
                            </div>
                        </div>
                        <button onclick="handleSaveConfig()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black shadow-xl">บันทึกข้อมูลทั่วไป</button>
                    </div>
                    
                    <div class="pt-8 border-t border-slate-100 space-y-6">
                        <div class="flex justify-between items-center">
                            <h4 class="font-black text-slate-800">จัดการของรางวัล</h4>
                            <button onclick="openAddRewardModal()" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                        <div id="reward-list-mini" class="space-y-3">
                            ${state.rewards.length > 0 ? state.rewards.map(r => `
                                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100/50">
                                    <div class="text-left">
                                        <p class="font-bold text-slate-800 text-sm">${r.name}</p>
                                        <p class="text-[9px] font-black text-indigo-500 uppercase tracking-widest">${r.points} แต้ม</p>
                                    </div>
                                    <button onclick="handleDeleteReward('${r.id}')" class="p-2 text-rose-300 hover:text-rose-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('') : '<p class="text-center py-4 text-xs text-slate-400 italic">ยังไม่มีรางวัล</p>'}
                        </div>
                    </div>
                </div>
            `);
        };

        window.openAddRewardModal = () => {
            openModal("เพิ่มของรางวัลใหม่", `
                <div class="space-y-6">
                    <div class="space-y-4">
                        <input id="reward-name-input" placeholder="เช่น กาแฟฟรี 1 แก้ว" class="w-full p-4 rounded-2xl bg-slate-50 border-none font-bold outline-none" />
                        <input id="reward-pts-input" type="number" placeholder="ใช้แต้มเท่าไหร่?" class="w-full p-4 rounded-2xl bg-slate-50 border-none font-bold outline-none" />
                    </div>
                    <button onclick="handleSaveNewReward()" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black">บันทึกของรางวัล</button>
                    <button onclick="openSettingsModal()" class="w-full text-slate-400 font-bold text-xs py-2">ยกเลิกและย้อนกลับ</button>
                </div>
            `);
        };

        window.handleSaveNewReward = async () => {
            const name = document.getElementById('reward-name-input').value;
            const pts = document.getElementById('reward-pts-input').value;
            if (!name || isNaN(pts)) return showMsg("กรุณาระบุข้อมูลให้ครบ", "error");
            try {
                await addDoc(collection(db, 'artifacts', finalAppId, 'public', 'data', 'rewards'), { 
                    name, points: parseInt(pts), createdAt: serverTimestamp() 
                });
                showMsg("เพิ่มรางวัลสำเร็จ");
                openSettingsModal();
            } catch (e) { showMsg("เกิดข้อผิดพลาด", "error"); }
        };

        window.handleDeleteReward = async (id) => {
            try {
                await deleteDoc(doc(db, 'artifacts', finalAppId, 'public', 'data', 'rewards', id));
                showMsg("ลบรางวัลแล้ว");
                openSettingsModal();
            } catch (e) { showMsg("ลบไม่สำเร็จ", "error"); }
        };

        window.handleSaveConfig = async () => {
            const name = document.getElementById('set-store-name').value;
            try {
                await setDoc(doc(db, 'artifacts', finalAppId, 'public', 'data', 'settings', 'app_config'), { ...state.config, storeName: name });
                showMsg("บันทึกการตั้งค่าสำเร็จ");
                closeModal();
            } catch (e) { showMsg("ล้มเหลว", "error"); }
        };

        window.handleSaveRule = (m) => { state.config.multiplier = m; window.handleSaveConfig(); };

        // --- UI Rendering ---

        const renderLanding = (el) => {
            el.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[85vh] text-center p-6 space-y-12 animate-in">
                    <div class="relative">
                        <div class="absolute inset-0 bg-indigo-500 blur-[80px] opacity-20 rounded-full scale-150"></div>
                        <div class="bg-indigo-600 p-9 rounded-[3rem] text-white shadow-2xl relative ring-8 ring-indigo-50">
                            <i data-lucide="crown" class="w-16 h-16"></i>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h2 class="text-4xl font-black text-slate-900 leading-[1.1] tracking-tight">Privilege &<br>Loyalty System</h2>
                        <p class="text-slate-400 font-medium max-w-[220px] mx-auto text-sm leading-relaxed">แพลตฟอร์มสะสมแต้มระดับพรีเมียม ปลอดภัยด้วยระบบ OTP</p>
                    </div>
                    <button onclick="requestOtpPopup()" class="w-full bg-slate-900 text-white py-6 rounded-[2.5rem] font-black shadow-2xl shadow-slate-200 hover:scale-[1.02] active:scale-95 transition-all text-lg tracking-wide">
                        เริ่มต้นใช้งานเลย
                    </button>
                    <p class="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em]">Modern Business Solution</p>
                </div>
            `;
            refreshIcons();
        };

        const renderCustomerDashboard = (el) => {
            const tier = getTier(state.userData?.totalPointsEarned || 0);
            el.innerHTML = `
                <div class="space-y-8 animate-in pt-2">
                    <div class="${tier.class} rounded-[3rem] p-9 text-white shadow-2xl relative overflow-hidden ring-1 ring-white/30 group">
                        <div class="absolute -right-6 -top-6 opacity-10 group-hover:scale-110 transition-transform duration-700">
                            <i data-lucide="${tier.icon}" style="width:200px;height:200px"></i>
                        </div>
                        <div class="relative z-10 space-y-8">
                            <div class="flex justify-between items-center">
                                <div class="bg-white/20 px-4 py-1.5 rounded-full backdrop-blur-md border border-white/20">
                                    <p class="text-[10px] font-black uppercase tracking-widest">${tier.name} Member</p>
                                </div>
                                <div class="bg-white/20 p-2.5 rounded-2xl backdrop-blur-md border border-white/20"><i data-lucide="${tier.icon}" class="w-5 h-5"></i></div>
                            </div>
                            <div class="text-left">
                                <p class="text-[10px] font-black uppercase tracking-[0.25em] opacity-60 ml-1">คะแนนสะสมปัจจุบัน</p>
                                <h2 class="text-7xl font-black tracking-tighter mt-1">${(state.userData?.points || 0).toLocaleString()} <span class="text-lg font-bold">pts</span></h2>
                            </div>
                            <div class="pt-8 border-t border-white/10 flex justify-between items-center text-[10px] font-black tracking-widest uppercase">
                                <span class="bg-indigo-900/20 px-4 py-2 rounded-xl border border-white/5">${state.userData?.name}</span>
                                <span class="opacity-50">${state.userData?.phone}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white border border-slate-100 p-7 rounded-[2.5rem] flex flex-col gap-2 shadow-sm text-left">
                            <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 mb-2 shadow-inner"><i data-lucide="trending-up" class="w-6 h-6"></i></div>
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">Total Earned</h4>
                            <p class="text-2xl font-black text-emerald-600">${(state.userData?.totalPointsEarned || 0).toLocaleString()}</p>
                        </div>
                        <div class="bg-white border border-slate-100 p-7 rounded-[2.5rem] flex flex-col gap-2 shadow-sm text-left">
                            <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 mb-2 shadow-inner"><i data-lucide="history" class="w-6 h-6"></i></div>
                            <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">Activity Count</h4>
                            <p class="text-2xl font-black text-indigo-600">${state.transactions.length}</p>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <div class="flex justify-between items-end px-2">
                            <h4 class="font-black text-xl text-slate-800 tracking-tight">กิจกรรมล่าสุด</h4>
                            <button onclick="switchView('history')" class="text-indigo-600 text-xs font-black uppercase tracking-widest mb-1">See All</button>
                        </div>
                        <div class="space-y-4">
                            ${state.transactions.slice(0, 3).map(t => `
                                <div class="bg-white border border-slate-50 p-5 rounded-3xl flex justify-between items-center shadow-sm group hover:border-indigo-100 transition-all text-left">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 ${t.amount > 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'} rounded-2xl flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform">
                                            <i data-lucide="${t.amount > 0 ? 'arrow-up-right' : 'arrow-down-right'}" class="w-6 h-6"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-sm text-slate-700 leading-tight">${t.reason}</p>
                                            <p class="text-[10px] text-slate-400 mt-1.5 font-medium italic">${t.timestamp?.toDate ? t.timestamp.toDate().toLocaleDateString('th-TH', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}) : '...'}</p>
                                        </div>
                                    </div>
                                    <div class="font-black text-xl ${t.amount > 0 ? 'text-emerald-600' : 'text-rose-600'}">${t.amount > 0 ? '+' : ''}${t.amount}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            refreshIcons();
        };

        const renderAdminReport = (el) => {
            const totalGiven = state.transactions.filter(t => t.type === 'earn').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalRedeemed = state.transactions.filter(t => t.type === 'redeem').reduce((sum, t) => sum + Math.abs(t.amount || 0), 0);
            el.innerHTML = `
                <div class="space-y-8 animate-in pt-2">
                    <h2 class="text-3xl font-black text-slate-800 tracking-tighter text-left">Business<br>Dashboard</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-900 p-7 rounded-[2.5rem] text-white shadow-2xl shadow-slate-200 text-left">
                            <p class="text-[10px] font-black opacity-40 uppercase tracking-[0.2em] mb-2">Customers</p>
                            <h3 class="text-4xl font-black">${state.allCustomers.length}</h3>
                        </div>
                        <div class="bg-white border border-slate-100 p-7 rounded-[2.5rem] shadow-sm text-left">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">Issued Pts</p>
                            <h3 class="text-4xl font-black text-indigo-600">${totalGiven.toLocaleString()}</h3>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 border border-indigo-100 p-9 rounded-[3.5rem] space-y-8 shadow-inner shadow-indigo-100/50">
                        <div class="flex justify-between items-end">
                            <div class="text-left">
                                <h4 class="font-black text-slate-800 text-lg">สถิติการใช้งาน</h4>
                                <p class="text-xs text-slate-400 font-bold mt-1 uppercase tracking-widest">Redemption Rate</p>
                            </div>
                            <span class="bg-white px-5 py-2 rounded-full text-sm font-black text-indigo-600 shadow-sm">${totalGiven > 0 ? Math.round((totalRedeemed/totalGiven)*100) : 0}%</span>
                        </div>
                        <div class="w-full bg-white h-4 rounded-full overflow-hidden p-1 shadow-inner">
                            <div class="bg-indigo-600 h-full rounded-full shadow-lg transition-all duration-1000" style="width: ${totalGiven > 0 ? Math.min(100, (totalRedeemed/totalGiven)*100) : 0}%"></div>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <h4 class="font-black text-xl text-slate-800 px-2 tracking-tight text-left">ลูกค้าสะสมสูงสุด</h4>
                        <div class="space-y-3">
                            ${state.allCustomers.sort((a,b) => (b.points||0) - (a.points||0)).slice(0, 5).map((c, i) => `
                                <div class="bg-white p-5 rounded-3xl border border-slate-50 flex justify-between items-center shadow-sm">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-slate-50 rounded-xl flex items-center justify-center font-black text-indigo-600 text-xs shadow-inner">${i+1}</div>
                                        <div class="text-left">
                                            <p class="font-bold text-sm text-slate-800">${c.name || 'Anonymous'}</p>
                                            <p class="text-[10px] text-slate-400 font-medium mt-0.5">${c.phone}</p>
                                        </div>
                                    </div>
                                    <p class="font-black text-indigo-600">${(c.points || 0).toLocaleString()} <span class="text-[8px] uppercase opacity-40">pts</span></p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            refreshIcons();
        };

        const renderRewards = (el) => {
            el.innerHTML = `
                <div class="space-y-8 animate-in pt-2 pb-10">
                    <h2 class="text-3xl font-black text-slate-800 tracking-tighter text-left">แลกของรางวัล</h2>
                    <div class="grid grid-cols-1 gap-6">
                        ${state.rewards.length > 0 ? state.rewards.map(r => `
                            <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-xl overflow-hidden group">
                                <div class="h-40 bg-indigo-50 flex items-center justify-center relative">
                                    <i data-lucide="gift" class="w-16 h-16 text-indigo-100"></i>
                                    <div class="absolute top-6 right-6 bg-slate-900 text-white px-5 py-2 rounded-2xl text-sm font-black shadow-2xl">${r.points} <span class="text-[9px] uppercase opacity-60 ml-1">pts</span></div>
                                </div>
                                <div class="p-8 text-left">
                                    <h3 class="font-black text-2xl text-slate-800 mb-2">${r.name}</h3>
                                    <p class="text-sm text-slate-400 font-medium mb-8 leading-relaxed">ใช้คะแนนของคุณแลกรับสิทธิ์ได้ทันทีที่สาขา</p>
                                    <button onclick="handleRedeem('${r.id}')" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-xl disabled:opacity-30" ${state.userData?.points < r.points ? 'disabled' : ''}>
                                        ${state.userData?.points >= r.points ? 'ยืนยันการแลกรางวัล' : 'แต้มสะสมยังไม่เพียงพอ'}
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<div class="text-center py-20 bg-slate-50 rounded-[3rem] border border-dashed"><p class="text-slate-400 font-black text-xs uppercase tracking-widest">No rewards available yet</p></div>'}
                    </div>
                </div>
            `;
            refreshIcons();
        };

        const renderCoupons = (el) => {
            el.innerHTML = `
                <div class="space-y-8 animate-in pt-2 pb-10">
                    <h2 class="text-3xl font-black text-slate-800 tracking-tighter text-left">คูปองของฉัน</h2>
                    <div class="space-y-6">
                        ${state.coupons.map(c => `
                            <div class="bg-white border-2 border-dashed ${c.status === 'used' ? 'opacity-40 border-slate-200' : 'border-indigo-100'} p-8 rounded-[3rem] text-center space-y-6 relative overflow-hidden shadow-sm">
                                ${c.status === 'used' ? '<div class="absolute inset-0 bg-white/60 z-20 flex items-center justify-center font-black text-rose-50 text-3xl rotate-12 uppercase tracking-tighter">Used Already</div>' : ''}
                                <div class="space-y-1 relative z-10">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Your Private Code</p>
                                    <h3 class="text-3xl font-black text-indigo-600 tracking-[0.2em]">${c.code}</h3>
                                </div>
                                <div class="bg-slate-50 p-6 rounded-[2rem] flex flex-col items-center relative z-10 shadow-inner">
                                    <div id="qr-${c.id}" class="mb-4 bg-white p-3 rounded-2xl"></div>
                                    <p class="font-black text-slate-800 text-lg uppercase leading-tight">${c.rewardName}</p>
                                </div>
                                <p class="text-[10px] text-slate-400 font-bold italic">โปรดยื่นรหัสนี้ให้กับพนักงานที่เคาน์เตอร์</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            state.coupons.forEach(c => {
                const container = document.getElementById(`qr-${c.id}`);
                if (container) new QRCode(container, { text: c.code, width: 100, height: 100, colorDark: c.status === 'used' ? '#94a3b8' : '#4f46e5' });
            });
            refreshIcons();
        };

        const renderHistory = (el) => {
            el.innerHTML = `
                <div class="space-y-8 animate-in pt-2 pb-10">
                    <h2 class="text-3xl font-black text-slate-800 tracking-tighter text-left">ประวัติรายการ</h2>
                    <div class="space-y-4">
                        ${state.transactions.map(t => `
                            <div class="bg-white border border-slate-50 p-6 rounded-[2rem] flex justify-between items-center shadow-sm text-left">
                                <div class="flex items-center gap-5">
                                    <div class="w-14 h-14 ${t.amount > 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'} rounded-[1.25rem] flex items-center justify-center">
                                        <i data-lucide="${t.amount > 0 ? 'plus' : 'minus'}" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <p class="font-black text-slate-800 text-sm tracking-tight">${t.reason}</p>
                                        <p class="text-[10px] text-slate-400 mt-1 font-bold italic">${t.timestamp?.toDate ? t.timestamp.toDate().toLocaleString('th-TH') : '...'}</p>
                                    </div>
                                </div>
                                <div class="font-black text-2xl ${t.amount > 0 ? 'text-emerald-600' : 'text-rose-600'}">${t.amount > 0 ? '+' : ''}${t.amount}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            refreshIcons();
        };

        // --- Core Navigation ---

        const updateUI = () => {
            const main = document.getElementById('main-content');
            const header = document.getElementById('app-header');
            const bNav = document.getElementById('bottom-nav');
            if (!main || !header || !bNav) return;
            
            if (!state.user || !state.userData) {
                renderLanding(main);
                header.classList.add('hidden');
                bNav.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
                bNav.classList.remove('hidden');
                document.getElementById('nav-store-name').innerText = state.config.storeName;
                document.getElementById('role-cust').className = state.role === 'customer' ? 'px-4 py-1.5 rounded-full text-[10px] font-black transition-all bg-white shadow-sm text-indigo-600' : 'px-4 py-1.5 rounded-full text-[10px] font-black transition-all text-slate-400';
                document.getElementById('role-admin').className = state.role === 'admin' ? 'px-4 py-1.5 rounded-full text-[10px] font-black transition-all bg-white shadow-sm text-indigo-600' : 'px-4 py-1.5 rounded-full text-[10px] font-black transition-all text-slate-400';
                
                if (state.role === 'customer') {
                    if (state.view === 'dashboard') renderCustomerDashboard(main);
                    else if (state.view === 'rewards') renderRewards(main);
                    else if (state.view === 'coupons') renderCoupons(main);
                    else if (state.view === 'history') renderHistory(main);
                } else {
                    renderAdminReport(main);
                }
                
                renderBottomNavItems(bNav);
            }
            refreshIcons();
        };

        const renderBottomNavItems = (el) => {
            const items = state.role === 'customer' 
                ? [
                    { id: 'dashboard', icon: 'home', label: 'Home', action: 'switchView("dashboard")' },
                    { id: 'rewards', icon: 'gift', label: 'Redeem', action: 'switchView("rewards")' },
                    { id: 'coupons', icon: 'ticket', label: 'Ticket', action: 'switchView("coupons")' },
                    { id: 'history', icon: 'list', label: 'Logs', action: 'switchView("history")' }
                ]
                : [
                    { id: 'admin_report', icon: 'bar-chart-3', label: 'Report', action: 'switchView("admin_report")' },
                    { id: 'give', icon: 'plus-circle', label: 'Give', action: 'openGivePointsModal()' },
                    { id: 'verify', icon: 'check-square', label: 'Verify', action: 'openVerifyCouponModal()' },
                    { id: 'settings', icon: 'settings', label: 'Setup', action: 'openSettingsModal()' }
                ];
            
            el.innerHTML = items.map(i => `
                <button onclick="${i.action}" class="flex flex-col items-center justify-center w-16 h-16 rounded-[1.25rem] transition-all relative ${state.view === i.id ? 'text-indigo-600' : 'text-slate-400'}">
                    <i data-lucide="${i.icon}" class="${state.view === i.id ? 'w-6 h-6' : 'w-5 h-5'} transition-all"></i>
                    <span class="text-[8px] font-black uppercase mt-1.5 tracking-widest">${i.label}</span>
                    ${state.view === i.id ? '<div class="absolute -bottom-1 w-1 h-1 bg-indigo-600 rounded-full"></div>' : ''}
                </button>
            `).join('');
            refreshIcons();
        };

        // --- Window Binding for Global Calls ---
        window.updateUI = updateUI;
        window.switchRole = (r) => { state.role = r; state.view = r === 'admin' ? 'admin_report' : 'dashboard'; window.updateUI(); };
        window.switchView = (v) => { state.view = v; window.updateUI(); };

        // --- Firebase Listeners ---

        const startDataSync = (u) => {
            const appId = finalAppId;
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'app_config'), (d) => { if (d.exists()) state.config = d.data(); window.updateUI(); }, (e) => console.warn(e));
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.uid), (d) => { if (d.exists()) { state.userData = d.data(); window.updateUI(); } else { state.userData = null; window.updateUI(); } }, (e) => console.warn(e));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'rewards'), (s) => { state.rewards = s.docs.map(d => ({id: d.id, ...d.data()})); window.updateUI(); }, (e) => console.warn(e));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => { state.allCustomers = s.docs.map(d => d.data()); window.updateUI(); }, (e) => console.warn(e));
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), (s) => { 
                const all = s.docs.map(d => ({id: d.id, ...d.data()})); 
                state.coupons = all.filter(c => c.userId === u.uid || state.role === 'admin').sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                window.updateUI(); 
            }, (e) => console.warn(e));

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), (s) => {
                const all = s.docs.map(d => d.data());
                state.transactions = all.filter(t => t.userId === u.uid || state.role === 'admin').sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                window.updateUI();
            }, (e) => console.warn(e));

            // URL Redemption
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                window.history.replaceState({}, document.title, window.location.pathname);
                redeemQrToken(token, u);
            }
        };

        const redeemQrToken = async (tokenId, user) => {
            const tokenRef = doc(db, 'artifacts', finalAppId, 'public', 'data', 'qr_tokens', tokenId);
            const tokenDoc = await getDoc(tokenRef);
            if (tokenDoc.exists() && tokenDoc.data().status === 'active') {
                const pts = tokenDoc.data().points;
                try {
                    await runTransaction(db, async (tx) => {
                        const userRef = doc(db, 'artifacts', finalAppId, 'public', 'data', 'users', user.uid);
                        const uDoc = await tx.get(userRef);
                        const cur = uDoc.exists() ? (uDoc.data().points || 0) : 0;
                        const tot = uDoc.exists() ? (uDoc.data().totalPointsEarned || 0) : 0;
                        tx.set(userRef, { points: cur + pts, totalPointsEarned: tot + pts }, { merge: true });
                        tx.update(tokenRef, { status: 'used', usedBy: user.uid, usedAt: serverTimestamp() });
                        tx.set(doc(collection(db, 'artifacts', finalAppId, 'public', 'data', 'transactions')), {
                            userId: user.uid, amount: pts, reason: 'Scan QR Verified', type: 'earn', timestamp: serverTimestamp()
                        });
                    });
                    showMsg(`รับเพิ่ม ${pts} แต้มสำเร็จ!`);
                } catch (e) { showMsg("Error receiving points", "error"); }
            } else showMsg("คิวอาร์นี้ถูกใช้ไปแล้ว", "error");
        };

        window.handleRedeem = async (rid) => {
            const reward = state.rewards.find(r => r.id === rid);
            if (!reward || !state.userData || state.userData.points < reward.points) return showMsg("แต้มไม่พอ", "error");
            try {
                await runTransaction(db, async (tx) => {
                    const userRef = doc(db, 'artifacts', finalAppId, 'public', 'data', 'users', state.user.uid);
                    const userDoc = await tx.get(userRef);
                    const currentPoints = userDoc.data().points;
                    if (currentPoints < reward.points) throw new Error("แต้มไม่พอ");
                    tx.update(userRef, { points: currentPoints - reward.points });
                    const couponRef = doc(collection(db, 'artifacts', finalAppId, 'public', 'data', 'coupons'));
                    tx.set(couponRef, {
                        userId: state.user.uid, rewardName: reward.name, pointsUsed: reward.points, status: 'active',
                        code: Math.random().toString(36).substring(7).toUpperCase(), timestamp: serverTimestamp()
                    });
                    tx.set(doc(collection(db, 'artifacts', finalAppId, 'public', 'data', 'transactions')), {
                        userId: state.user.uid, amount: -reward.points, reason: `แลก: ${reward.name}`, type: 'redeem', timestamp: serverTimestamp()
                    });
                });
                showMsg("แลกรางวัลสำเร็จ!");
                state.view = 'coupons';
                window.updateUI();
            } catch (e) { showMsg(e.message, "error"); }
        };

        // --- Initialize Auth ---

        onAuthStateChanged(auth, (u) => {
            const loader = document.getElementById('loading-screen');
            if (loader) loader.classList.add('hidden');
            
            if (u) {
                state.user = u;
                startDataSync(u);
            } else {
                state.user = null;
                state.userData = null;
                window.updateUI();
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(refreshIcons, 500);
        });

    </script>
</body>
</html>
