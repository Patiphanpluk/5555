<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- ล็อกไม่ให้ซูมหน้าเว็บอย่างเข้มงวดและรองรับพื้นที่ปลอดภัยของอุปกรณ์ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Loyalty Premium - Universal System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        
        :root {
            --app-bg: #f8fafc;
            --primary: #4f46e5;
        }

        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: var(--app-bg);
            /* ล็อกการซูมและท่าทางสัมผัสที่อาจทำให้หน้าจอเลื่อนเพี้ยน */
            touch-action: pan-x pan-y;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* ล็อก Scroll เมื่อเปิด Modal */
        body.modal-open {
            overflow: hidden;
            height: 100vh;
        }

        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .tier-silver { background: linear-gradient(135deg, #94a3b8, #475569); }
        .tier-gold { background: linear-gradient(135deg, #fbbf24, #b45309); }
        .tier-platinum { background: linear-gradient(135deg, #818cf8, #4338ca); }

        .floating-nav {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 550px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 32px;
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            display: flex;
            padding: 10px;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 520px;
            border-radius: 40px;
            padding: 40px;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-active .modal-content { transform: scale(1); opacity: 1; }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .otp-input:focus { letter-spacing: 0.8rem; }
        
        button { transition: all 0.2s ease; outline: none !important; }
        button:active { transform: scale(0.95); }

        .glass-card {
            background: white;
            border: 1px solid rgba(241, 245, 249, 1);
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            box-shadow: 0 12px 30px -4px rgba(0, 0, 0, 0.08);
            transform: translateY(-4px);
        }

        /* Desktop Layout Optimization */
        @media (min-width: 1024px) {
            .grid-dashboard {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 2.5rem;
            }
            .grid-span-full {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body class="text-slate-900">

    <div id="app" class="min-h-screen flex flex-col relative w-full bg-slate-50">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-white z-[500] flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-600 border-r-transparent mx-auto mb-6"></div>
                <p class="text-sm font-bold text-slate-400 tracking-[0.4em] uppercase animate-pulse">Initializing System</p>
            </div>
        </div>

        <!-- App Header -->
        <header id="app-header" class="hidden px-6 md:px-12 py-6 sticky top-0 bg-white/80 backdrop-blur-xl z-50 border-b border-slate-100">
            <div class="max-w-6xl mx-auto w-full flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-indigo-600 p-2.5 rounded-2xl text-white shadow-xl shadow-indigo-100">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </div>
                    <div class="text-left">
                        <h1 id="nav-store-name" class="font-black text-xl md:text-2xl text-slate-800 truncate leading-none">Store</h1>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1.5">Elite Loyalty Program</p>
                    </div>
                </div>
                <div class="bg-slate-100 p-1.5 rounded-full flex scale-90 md:scale-100 shadow-inner border border-slate-200/50">
                    <button onclick="switchRole('customer')" id="role-cust" class="px-6 py-2.5 rounded-full text-[11px] font-black transition-all">USER</button>
                    <button onclick="switchRole('admin')" id="role-admin" class="px-6 py-2.5 rounded-full text-[11px] font-black transition-all">ADMIN</button>
                </div>
            </div>
        </header>

        <!-- Main Content View -->
        <main id="main-content" class="flex-grow max-w-6xl mx-auto w-full p-6 md:p-12 pb-44">
            <!-- Dynamic Content -->
        </main>

        <!-- Floating Footer Nav -->
        <nav id="bottom-nav" class="hidden floating-nav">
            <!-- Buttons dynamically populated -->
        </nav>

        <!-- Universal Modal System -->
        <div id="modal-overlay" class="modal-overlay" onclick="closeModal()">
            <div class="modal-content shadow-2xl relative" onclick="event.stopPropagation()">
                <button onclick="closeModal()" class="absolute top-10 right-10 p-2.5 bg-slate-50 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <h3 id="modal-title" class="text-3xl font-black text-slate-800 mb-10 pr-12 text-left">Title</h3>
                <div id="modal-body" class="max-h-[75vh] overflow-y-auto hide-scroll text-left">
                    <!-- Modal body -->
                </div>
            </div>
        </div>

        <!-- Global Notifications -->
        <div id="notif" class="fixed top-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[450px] z-[400] pointer-events-none space-y-4"></div>
        
        <!-- Invisible Recaptcha -->
        <div id="recaptcha-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot, serverTimestamp, runTransaction, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const userConfig = {
            apiKey: "AIzaSyDadMZYr6lioUdc894l7PZzt6dxs8Ep_gw",
            authDomain: "test-318d9.firebaseapp.com",
            projectId: "test-318d9",
            storageBucket: "test-318d9.firebasestorage.app",
            messagingSenderId: "313725009474",
            appId: "1:313725009474:web:42d018f2b4a4ae2c1977db",
            measurementId: "G-0J344393JS"
        };

        const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'loyalty-v8-final';

        const firebaseApp = initializeApp(config);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- Application State ---
        window.state = {
            user: null,
            role: 'customer',
            view: 'dashboard',
            userData: null,
            config: { storeName: 'Premium Rewards', multiplier: 1 },
            rewards: [],
            transactions: [],
            allCustomers: [],
            coupons: [],
            confirmationResult: null,
            tempPhone: ''
        };

        // --- Core Helpers ---
        const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
        
        const showMsg = (text, type = 'success') => {
            const container = document.getElementById('notif');
            if (!container) return;
            const id = 'm' + Date.now();
            const bg = type === 'error' ? 'bg-rose-600' : 'bg-slate-900';
            container.innerHTML += `<div id="${id}" class="${bg} text-white px-8 py-5 rounded-[2.5rem] shadow-2xl flex items-center gap-5 animate-in text-sm font-bold border border-white/10">
                <i data-lucide="${type === 'error' ? 'alert-circle' : 'check-circle'}" class="w-6 h-6"></i> ${text}
            </div>`;
            refreshIcons();
            setTimeout(() => document.getElementById(id)?.remove(), 4000);
        };

        window.openModal = (title, bodyHtml) => {
            const overlay = document.getElementById('modal-overlay');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = bodyHtml;
            overlay.style.display = 'flex';
            document.body.classList.add('modal-open');
            setTimeout(() => overlay.classList.add('modal-active'), 10);
            refreshIcons();
        };

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            if (!overlay) return;
            overlay.classList.remove('modal-active');
            document.body.classList.remove('modal-open');
            setTimeout(() => overlay.style.display = 'none', 350);
        };

        const getTier = (pts) => {
            if (pts >= 5000) return { name: 'Platinum', class: 'tier-platinum', icon: 'zap' };
            if (pts >= 1000) return { name: 'Gold', class: 'tier-gold', icon: 'star' };
            return { name: 'Silver', class: 'tier-silver', icon: 'shield' };
        };

        // --- UI Update Gatekeeper ---
        window.updateUI = () => {
            const main = document.getElementById('main-content');
            const header = document.getElementById('app-header');
            const bNav = document.getElementById('bottom-nav');
            if (!main || !header || !bNav) return;
            
            if (!state.user || !state.userData) {
                renderLanding(main);
                header.classList.add('hidden');
                bNav.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
                bNav.classList.remove('hidden');
                document.getElementById('nav-store-name').innerText = state.config.storeName;
                document.getElementById('role-cust').className = state.role === 'customer' ? 'px-6 py-2.5 rounded-full text-[11px] font-black transition-all bg-white shadow-sm text-indigo-600 border border-indigo-100' : 'px-6 py-2.5 rounded-full text-[11px] font-black transition-all text-slate-400';
                document.getElementById('role-admin').className = state.role === 'admin' ? 'px-6 py-2.5 rounded-full text-[11px] font-black transition-all bg-white shadow-sm text-indigo-600 border border-indigo-100' : 'px-6 py-2.5 rounded-full text-[11px] font-black transition-all text-slate-400';
                
                if (state.role === 'customer') {
                    if (state.view === 'dashboard') renderDashboard(main);
                    else if (state.view === 'rewards') renderRewards(main);
                    else if (state.view === 'coupons') renderCoupons(main);
                    else if (state.view === 'history') renderHistory(main);
                } else {
                    renderAdminPanel(main);
                }
                renderBottomNav(bNav);
            }
            refreshIcons();
        };

        // --- Authentication Core (Fixed auth/internal-error) ---

        window.requestOtpPopup = () => {
            openModal("Elite Experience", `
                <div class="space-y-10">
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase ml-5 tracking-[0.2em]">Phone Number</label>
                            <input id="login-phone" type="tel" placeholder="08XXXXXXXX" class="w-full p-7 rounded-[2.5rem] bg-slate-50 border-none outline-none font-black text-center text-3xl focus:ring-4 focus:ring-indigo-100" />
                        </div>
                        <div class="space-y-2">
                            <label class="text-[11px] font-black text-slate-400 uppercase ml-5 tracking-[0.2em]">Display Name</label>
                            <input id="login-name" type="text" placeholder="Your Name" class="w-full p-7 rounded-[2.5rem] bg-slate-50 border-none outline-none font-bold text-center text-2xl focus:ring-4 focus:ring-indigo-100" />
                        </div>
                        <button id="send-otp-btn" onclick="handleSendOtp()" class="w-full bg-indigo-600 text-white py-7 rounded-[2.5rem] font-black shadow-2xl shadow-indigo-100 text-xl mt-6">Get OTP Code</button>
                    </div>
                </div>
            `);
        };

        window.handleSendOtp = async () => {
            const phone = document.getElementById('login-phone').value;
            const name = document.getElementById('login-name').value;
            const btn = document.getElementById('send-otp-btn');
            
            if (!phone || phone.length < 10) return showMsg("กรุณาระบุเบอร์โทรศัพท์ให้ถูกต้อง", "error");
            
            btn.disabled = true;
            btn.innerText = "Processing...";
            
            let formattedPhone = phone.startsWith('0') ? '+66' + phone.substring(1) : phone;
            
            try {
                // Safely clear old verifier instance
                if (window.recaptchaVerifier) {
                    try { window.recaptchaVerifier.clear(); } catch(e) {}
                }

                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 
                    size: 'invisible',
                    callback: () => {}
                });

                state.tempPhone = phone;
                state.confirmationResult = await signInWithPhoneNumber(auth, formattedPhone, window.recaptchaVerifier);
                showMsg("ส่งรหัสยืนยันสำเร็จ");
                
                openModal("ระบุรหัส OTP", `
                    <div class="space-y-12 text-center py-6">
                        <div class="space-y-2">
                            <p class="text-slate-500 font-medium text-lg uppercase tracking-widest">Verification Sent to</p>
                            <p class="text-indigo-600 font-black text-4xl tracking-tighter">${phone}</p>
                        </div>
                        <input id="login-otp" type="number" placeholder="XXXXXX" class="w-full p-10 rounded-[3rem] bg-slate-50 border-none outline-none font-black text-center text-7xl tracking-[1.5rem] otp-input focus:ring-4 focus:ring-emerald-100" maxlength="6" />
                        <button onclick="handleVerifyOtp('${name}')" class="w-full bg-emerald-600 text-white py-7 rounded-[3rem] font-black shadow-2xl text-2xl mt-10">Verify & Enter</button>
                        <button onclick="requestOtpPopup()" class="text-slate-400 font-black text-[11px] uppercase tracking-[0.3em] mt-8 hover:text-indigo-600">Change Phone Number</button>
                    </div>
                `);
            } catch (error) {
                console.error(error);
                showMsg("ระบบส่ง OTP ขัดข้อง: " + error.code, "error");
                btn.disabled = false;
                btn.innerText = "Get OTP Code";
            }
        };

        window.handleVerifyOtp = async (name) => {
            const code = document.getElementById('login-otp').value;
            if (!code || code.length !== 6) return showMsg("ระบุรหัส 6 หลัก", "error");
            try {
                const result = await state.confirmationResult.confirm(code);
                const user = result.user;
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    await setDoc(userRef, { 
                        uid: user.uid, phone: state.tempPhone, name: name || 'Valued Member', 
                        points: 0, totalPointsEarned: 0, role: 'customer', createdAt: serverTimestamp() 
                    });
                }
                closeModal();
                showMsg("ยินดีต้อนรับสู่ระบบสะสมแต้มครับ");
            } catch (e) { showMsg("รหัส OTP ไม่ถูกต้อง", "error"); }
        };

        window.handleLogout = async () => { await signOut(auth); location.reload(); };

        // --- Dashboard & Features ---

        const renderLanding = (el) => {
            el.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[85vh] text-center p-6 space-y-16 animate-in">
                    <div class="relative">
                        <div class="absolute inset-0 bg-indigo-500 blur-[150px] opacity-30 rounded-full scale-150"></div>
                        <div class="bg-indigo-600 p-12 rounded-[4.5rem] text-white shadow-2xl relative ring-[24px] ring-indigo-50/50">
                            <i data-lucide="crown" class="w-32 h-32"></i>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <h2 class="text-[5rem] md:text-[8rem] font-black text-slate-900 leading-[0.8] tracking-tighter">Elite<br>Rewards</h2>
                        <p class="text-slate-400 font-medium max-w-[400px] mx-auto text-2xl leading-relaxed">สัมผัสประสบการณ์สะสมแต้มแบบเหนือระดับ<br>ปลอดภัย ทันสมัย และง่ายกว่าที่เคย</p>
                    </div>
                    <button onclick="requestOtpPopup()" class="w-full max-w-md bg-slate-900 text-white py-9 rounded-[4rem] font-black shadow-2xl hover:bg-black text-2xl transition-all transform hover:scale-[1.05] tracking-widest">
                        เริ่มต้นใช้งาน
                    </button>
                    <p class="text-[11px] font-black text-slate-300 uppercase tracking-[0.5em] pt-12">Universal Loyalty Platform</p>
                </div>
            `;
        };

        const renderDashboard = (el) => {
            const tier = getTier(state.userData?.totalPointsEarned || 0);
            el.innerHTML = `
                <div class="main-grid animate-in">
                    <div class="${tier.class} rounded-[4.5rem] p-12 text-white shadow-2xl relative overflow-hidden group span-full border-4 border-white/20">
                        <div class="absolute -right-20 -top-20 opacity-10 group-hover:scale-110 transition-transform duration-1000">
                            <i data-lucide="${tier.icon}" style="width:450px;height:450px"></i>
                        </div>
                        <div class="relative z-10 space-y-20">
                            <div class="flex justify-between items-center">
                                <div class="bg-white/20 px-10 py-3.5 rounded-full backdrop-blur-md border border-white/20">
                                    <p class="text-xs font-black uppercase tracking-[0.5em]">${tier.name} Status</p>
                                </div>
                                <div class="bg-white/20 p-5 rounded-3xl backdrop-blur-md border border-white/20 shadow-2xl"><i data-lucide="${tier.icon}" class="w-12 h-12"></i></div>
                            </div>
                            <div class="text-left">
                                <p class="text-sm font-black uppercase tracking-[0.6em] opacity-60 ml-3 mb-2">Available Balance</p>
                                <h2 class="text-[12rem] font-black tracking-tighter leading-none">${(state.userData?.points || 0).toLocaleString()} <span class="text-4xl font-bold opacity-60 ml-6 uppercase">pts</span></h2>
                            </div>
                            <div class="pt-16 border-t border-white/10 flex justify-between items-center text-xs font-black tracking-[0.4em] uppercase">
                                <span class="bg-indigo-950/40 px-12 py-5 rounded-[2.5rem] border border-white/10 shadow-2xl">${state.userData?.name}</span>
                                <span class="opacity-50">${state.userData?.phone}</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-14 rounded-[4.5rem] flex flex-col gap-10 text-left group">
                        <div class="w-24 h-24 bg-emerald-50 rounded-[3rem] flex items-center justify-center text-emerald-600 shadow-inner group-hover:bg-emerald-600 group-hover:text-white transition-all duration-500"><i data-lucide="trending-up" class="w-12 h-12"></i></div>
                        <div>
                            <h4 class="text-sm font-black text-slate-400 uppercase tracking-widest leading-none">Lifetime Earned</h4>
                            <p class="text-7xl font-black text-emerald-600 mt-4 tracking-tighter leading-none">${(state.userData?.totalPointsEarned || 0).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="glass-card p-14 rounded-[4.5rem] flex flex-col gap-10 text-left group">
                        <div class="w-24 h-24 bg-indigo-50 rounded-[3rem] flex items-center justify-center text-indigo-600 shadow-inner group-hover:bg-indigo-600 group-hover:text-white transition-all duration-500"><i data-lucide="history" class="w-12 h-12"></i></div>
                        <div>
                            <h4 class="text-sm font-black text-slate-400 uppercase tracking-widest leading-none">Total Logs</h4>
                            <p class="text-7xl font-black text-indigo-600 mt-4 tracking-tighter leading-none">${state.transactions.length}</p>
                        </div>
                    </div>

                    <div class="span-full space-y-12 pt-20">
                        <h4 class="font-black text-6xl text-slate-800 px-10 tracking-tighter text-left leading-none">Activity Feed</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 pb-20">
                            ${state.transactions.slice(0, 9).map(t => `
                                <div class="bg-white border border-slate-100 p-12 rounded-[4rem] flex justify-between items-center shadow-sm hover:border-indigo-400 group transition-all text-left">
                                    <div class="flex items-center gap-10">
                                        <div class="w-24 h-24 ${t.amount > 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'} rounded-[2.5rem] flex items-center justify-center shadow-inner group-hover:scale-110 transition-transform">
                                            <i data-lucide="${t.amount > 0 ? 'plus' : 'minus'}" class="w-10 h-10"></i>
                                        </div>
                                        <div>
                                            <p class="font-black text-2xl text-slate-800 leading-none">${t.reason}</p>
                                            <p class="text-xs text-slate-400 mt-4 font-bold tracking-[0.2em] uppercase italic opacity-60">${t.timestamp?.toDate ? t.timestamp.toDate().toLocaleDateString('th-TH', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}) : 'Syncing...'}</p>
                                        </div>
                                    </div>
                                    <div class="font-black text-5xl ${t.amount > 0 ? 'text-emerald-600' : 'text-rose-600'}">${t.amount > 0 ? '+' : ''}${t.amount}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="span-full w-full text-slate-300 text-[11px] font-black py-16 tracking-[0.8em] uppercase hover:text-rose-500 transition-colors">Sign Out Securely</button>
                </div>
            `;
        };

        // --- Admin Dashboards ---

        const renderAdminPanel = (el) => {
            const totalIssued = state.transactions.filter(t => t.type === 'earn').reduce((sum, t) => sum + (t.amount || 0), 0);
            el.innerHTML = `
                <div class="space-y-16 animate-in pt-10 text-left">
                    <h2 class="text-7xl md:text-9xl font-black text-slate-800 tracking-tighter leading-none">Merchant Hub</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                        <div class="bg-slate-900 p-16 rounded-[5rem] text-white shadow-2xl ring-1 ring-white/10">
                            <p class="text-sm font-black opacity-40 uppercase tracking-[0.6em] mb-10">Members Pool</p>
                            <h3 class="text-[10rem] font-black tracking-tighter leading-none">${state.allCustomers.length}</h3>
                        </div>
                        <div class="bg-white border border-slate-100 p-16 rounded-[5rem] shadow-sm">
                            <p class="text-sm font-black text-slate-400 uppercase tracking-[0.6em] mb-10">Pts Inventory</p>
                            <h3 class="text-[10rem] font-black text-indigo-600 tracking-tighter leading-none">${totalIssued.toLocaleString()}</h3>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderRewards = (el) => {
            el.innerHTML = `
                <div class="space-y-16 animate-in pt-8 pb-20">
                    <h2 class="text-6xl font-black text-slate-800 tracking-tighter text-left">Elite Rewards</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12">
                        ${state.rewards.map(r => `
                            <div class="bg-white rounded-[5rem] border border-slate-100 shadow-2xl overflow-hidden group transition-all hover:translate-y-[-12px]">
                                <div class="h-72 bg-indigo-50 flex items-center justify-center relative">
                                    <i data-lucide="gift" class="w-40 h-40 text-indigo-100 group-hover:scale-125 transition-all duration-700"></i>
                                    <div class="absolute top-12 right-12 bg-slate-900 text-white px-10 py-4 rounded-3xl text-xl font-black shadow-2xl">${r.points} <span class="text-xs uppercase opacity-60 ml-3">Pts</span></div>
                                </div>
                                <div class="p-16 text-left">
                                    <h3 class="font-black text-5xl text-slate-800 mb-6 leading-[0.9] tracking-tighter uppercase">${r.name}</h3>
                                    <p class="text-lg text-slate-400 font-medium mb-16 leading-relaxed">Redeem your accumulated points for this exclusive award instantly at any branch.</p>
                                    <button onclick="handleRedeemReward('${r.id}')" class="w-full bg-indigo-600 text-white py-8 rounded-[3.5rem] font-black shadow-2xl text-2xl active:bg-indigo-700 active:scale-95 transition-all disabled:opacity-20" ${state.userData?.points < r.points ? 'disabled' : ''}>Confirm Exchange</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        // --- Popup Handlers (100% Popups) ---

        window.openGivePointsModal = () => {
            openModal("Issue Reward Points", `
                <div class="space-y-14 text-center py-10">
                    <div class="space-y-6 text-left px-4">
                        <label class="text-[11px] font-black text-slate-400 uppercase ml-8 tracking-[0.5em]">Input Base Amount</label>
                        <input id="admin-pts-input" type="number" value="10" class="w-full text-[12rem] text-center font-black text-indigo-600 bg-transparent outline-none leading-none tracking-tighter" />
                        <div class="bg-slate-950 py-7 px-14 rounded-[3.5rem] flex items-center justify-between text-white shadow-2xl w-full border border-white/10">
                            <span class="text-xs font-black opacity-40 uppercase tracking-[0.4em]">Current Rate: X${state.config.multiplier}</span>
                            <span id="pts-preview" class="text-5xl font-black tracking-tighter">${10 * state.config.multiplier} <span class="text-lg opacity-40">pts</span></span>
                        </div>
                    </div>
                    <button onclick="handleGenerateRewardQr()" class="w-full bg-indigo-600 text-white py-10 rounded-[4rem] font-black shadow-2xl text-3xl active:bg-indigo-700 tracking-tight">Generate Live Code</button>
                </div>
            `);
            const input = document.getElementById('admin-pts-input');
            input.addEventListener('input', () => {
                document.getElementById('pts-preview').innerHTML = (parseInt(input.value || 0) * state.config.multiplier) + ' <span class="text-lg opacity-40">pts</span>';
            });
        };

        window.handleGenerateRewardQr = async () => {
            const pts = document.getElementById('admin-pts-input').value;
            const finalPts = parseInt(pts) * state.config.multiplier;
            try {
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'qr_tokens'), {
                    points: finalPts, status: 'active', createdAt: serverTimestamp()
                });
                const url = `${window.location.origin}${window.location.pathname}?token=${docRef.id}`;
                openModal("Ready to Scan", `
                    <div class="flex flex-col items-center gap-16 p-10 text-center">
                        <div class="space-y-4">
                            <h4 class="font-black text-9xl text-indigo-600 tracking-tighter leading-none">${finalPts}</h4>
                            <p class="text-sm font-black text-slate-400 uppercase tracking-[0.8em]">Exclusive Credits</p>
                        </div>
                        <div id="modal-qrcode" class="p-14 bg-white rounded-[7rem] shadow-2xl border-[12px] border-slate-50 ring-1 ring-slate-100"></div>
                        <button onclick="closeModal()" class="w-full py-9 bg-slate-900 text-white rounded-[3.5rem] font-black text-3xl shadow-2xl active:bg-black">Finalize Transaction</button>
                        <p class="text-[10px] text-slate-300 font-mono break-all px-8 opacity-50">${url}</p>
                    </div>
                `);
                new QRCode(document.getElementById("modal-qrcode"), { text: url, width: 320, height: 320, colorDark: "#4f46e5" });
            } catch (e) { showMsg("QR Error", "error"); }
        };

        window.openVerifyCouponModal = () => {
            openModal("Redemption Verification", `
                <div class="space-y-16 text-center py-10 px-6">
                    <p class="text-slate-500 font-bold text-2xl leading-relaxed">Input the 6-digit confidential code shown on the customer's wallet screen.</p>
                    <input id="verify-code-input" placeholder="CODE" class="w-full p-12 rounded-[4rem] bg-slate-50 border-none text-center font-black text-[10rem] uppercase tracking-[1.5rem] outline-none focus:ring-8 focus:ring-indigo-50 leading-none" maxlength="6" />
                    <button onclick="handleVerifyConfirm()" class="w-full bg-indigo-600 text-white py-10 rounded-[4rem] font-black shadow-2xl text-4xl active:bg-indigo-700">Authorize Redemption</button>
                </div>
            `);
        };

        window.handleVerifyConfirm = async () => {
            const code = document.getElementById('verify-code-input').value.toUpperCase();
            const q = state.coupons.find(c => c.code === code && c.status === 'active');
            if (!q) return showMsg("ไม่พบคูปอง หรือรหัสถูกใช้งานไปแล้ว", "error");
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'coupons', q.id), { status: 'used', verifiedAt: serverTimestamp() });
                showMsg("ยืนยันรางวัลสำเร็จ!");
                closeModal();
            } catch (e) { showMsg("Failed", "error"); }
        };

        window.openSettingsModal = () => {
            openModal("Core Settings", `
                <div class="space-y-16 pb-14 text-left">
                    <div class="space-y-12">
                        <div class="space-y-4">
                            <label class="text-xs font-black text-slate-400 uppercase ml-10 tracking-[0.5em]">Identity Branding</label>
                            <input id="set-store-name" value="${state.config.storeName}" class="w-full p-8 rounded-[3.5rem] bg-slate-50 border-none font-black text-3xl outline-none focus:ring-8 focus:ring-indigo-100" />
                        </div>
                        <div class="space-y-4">
                            <label class="text-xs font-black text-slate-400 uppercase ml-10 tracking-[0.5em]">Global Multiplier</label>
                            <div class="flex gap-10">
                                ${[1,2,3].map(m => `<button onclick="handleQuickMulti(${m})" class="flex-1 py-10 rounded-[3rem] border-8 transition-all font-black text-5xl ${state.config.multiplier === m ? 'border-indigo-600 bg-indigo-600 text-white shadow-2xl' : 'border-slate-50 text-slate-300 hover:bg-slate-100'}">X${m}</button>`).join('')}
                            </div>
                        </div>
                        <button onclick="handleSaveSettings()" class="w-full bg-slate-900 text-white py-10 rounded-[4rem] font-black text-3xl shadow-2xl active:bg-black">Commit Global Changes</button>
                    </div>

                    <div class="pt-20 border-t-4 border-slate-50 space-y-12">
                        <div class="flex justify-between items-center px-6">
                            <h4 class="font-black text-5xl text-slate-800 tracking-tighter">Reward Inventory</h4>
                            <button onclick="openCreateRewardModal()" class="p-5 bg-indigo-600 text-white rounded-[2.5rem] shadow-2xl hover:scale-110 active:scale-95"><i data-lucide="plus" class="w-10 h-10"></i></button>
                        </div>
                        <div class="grid grid-cols-1 gap-8">
                            ${state.rewards.map(r => `
                                <div class="flex justify-between items-center p-10 bg-slate-50 rounded-[4rem] border-4 border-white hover:border-indigo-200 transition-all group">
                                    <div class="text-left">
                                        <p class="font-black text-3xl text-slate-800 leading-none tracking-tighter uppercase">${r.name}</p>
                                        <p class="text-sm font-black text-indigo-500 uppercase tracking-[0.4em] mt-5">${r.points} Points Req.</p>
                                    </div>
                                    <button onclick="handleDeleteReward('${r.id}')" class="p-5 text-rose-300 hover:text-rose-600 hover:bg-rose-50 rounded-3xl transition-all"><i data-lucide="trash-2" class="w-8 h-8"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="w-full text-rose-500 font-black text-sm tracking-[0.8rem] uppercase py-20 opacity-30 hover:opacity-100 transition-all">Sign Out Administrator</button>
                </div>
            `);
        };

        window.openCreateRewardModal = () => {
            openModal("New Asset Creation", `
                <div class="space-y-12 text-left py-4">
                    <div class="space-y-8">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-10 tracking-[0.4em]">Asset Name</label>
                            <input id="r-name" placeholder="E.g. Vintage Watch" class="w-full p-8 rounded-[3.5rem] bg-slate-50 border-none font-black text-3xl" />
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-10 tracking-[0.4em]">Points Valuation</label>
                            <input id="r-pts" type="number" placeholder="5000" class="w-full p-8 rounded-[3.5rem] bg-slate-50 border-none font-black text-3xl" />
                        </div>
                    </div>
                    <button onclick="handleCreateConfirm()" class="w-full bg-indigo-600 text-white py-10 rounded-[4rem] font-black text-3xl shadow-2xl active:bg-indigo-700">Deploy New Asset</button>
                    <button onclick="openSettingsModal()" class="w-full text-slate-400 font-black text-xs uppercase tracking-[0.5em] pt-8 text-center">Revert to Settings</button>
                </div>
            `);
        };

        window.handleCreateConfirm = async () => {
            const name = document.getElementById('r-name').value;
            const pts = document.getElementById('r-pts').value;
            if (!name || isNaN(pts)) return showMsg("ระบุข้อมูลให้ครบถ้วน", "error");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rewards'), { 
                    name, points: parseInt(pts), createdAt: serverTimestamp() 
                });
                showMsg("เพิ่มของรางวัลใหม่สำเร็จ");
                openSettingsModal();
            } catch (e) { showMsg("Error", "error"); }
        };

        window.handleDeleteReward = async (id) => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rewards', id));
                showMsg("ลบของรางวัลเรียบร้อย");
                openSettingsModal();
            } catch (e) { showMsg("Error", "error"); }
        };

        window.handleSaveSettings = async () => {
            const name = document.getElementById('set-store-name').value;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'app_config'), { ...state.config, storeName: name });
                showMsg("บันทึกการตั้งค่าสำเร็จ");
                closeModal();
            } catch (e) { showMsg("Error", "error"); }
        };

        window.handleQuickMulti = (m) => { state.config.multiplier = m; window.handleSaveSettings(); };

        // --- Navigation Logic ---

        const renderBottomNavItems = (el) => {
            const items = state.role === 'customer' 
                ? [
                    { id: 'dashboard', icon: 'home', label: 'Home', action: 'switchView("dashboard")' },
                    { id: 'rewards', icon: 'gift', label: 'Rewards', action: 'switchView("rewards")' },
                    { id: 'coupons', icon: 'ticket', label: 'Wallet', action: 'switchView("coupons")' },
                    { id: 'history', icon: 'list', label: 'Audit', action: 'switchView("history")' }
                ]
                : [
                    { id: 'admin_report', icon: 'bar-chart-3', label: 'Stats', action: 'switchView("admin_report")' },
                    { id: 'give', icon: 'plus-circle', label: 'Issue', action: 'openGivePointsModal()' },
                    { id: 'verify', icon: 'check-square', label: 'Verify', action: 'openVerifyCouponModal()' },
                    { id: 'settings', icon: 'settings', label: 'Config', action: 'openSettingsModal()' }
                ];
            
            el.innerHTML = items.map(i => `
                <button onclick="${i.action}" class="flex flex-col items-center justify-center flex-1 h-20 rounded-[2.5rem] transition-all relative ${state.view === i.id ? 'text-indigo-600 bg-indigo-50/70 border border-indigo-100 shadow-sm' : 'text-slate-400 hover:bg-slate-50'}">
                    <i data-lucide="${i.icon}" class="${state.view === i.id ? 'w-8 h-8' : 'w-7 h-7'} transition-all"></i>
                    <span class="text-[9px] font-black uppercase mt-2 tracking-widest">${i.label}</span>
                </button>
            `).join('');
            refreshIcons();
        };

        // --- Data Persistence Logic ---

        const startSync = (u) => {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'app_config'), (d) => { if (d.exists()) state.config = d.data(); window.updateUI(); }, (e) => console.warn(e));
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', u.uid), (d) => { if (d.exists()) state.userData = d.data(); else state.userData = null; window.updateUI(); }, (e) => console.warn(e));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'rewards'), (s) => { state.rewards = s.docs.map(d => ({id: d.id, ...d.data()})); window.updateUI(); }, (e) => console.warn(e));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (s) => { state.allCustomers = s.docs.map(d => d.data()); window.updateUI(); }, (e) => console.warn(e));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'), (s) => { 
                const all = s.docs.map(d => ({id: d.id, ...d.data()})); 
                state.coupons = all.filter(c => c.userId === u.uid || state.role === 'admin').sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                window.updateUI(); 
            }, (e) => console.warn(e));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), (s) => {
                const all = s.docs.map(d => d.data());
                state.transactions = all.filter(t => t.userId === u.uid || state.role === 'admin').sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                window.updateUI();
            }, (e) => console.warn(e));

            // ตรวจสอบ Token จาก QR
            const token = new URLSearchParams(window.location.search).get('token');
            if (token) {
                window.history.replaceState({}, document.title, window.location.pathname);
                redeemToken(token, u);
            }
        };

        const redeemToken = async (tokenId, user) => {
            const tokenRef = doc(db, 'artifacts', appId, 'public', 'data', 'qr_tokens', tokenId);
            const tokenDoc = await getDoc(tokenRef);
            if (tokenDoc.exists() && tokenDoc.data().status === 'active') {
                const pts = tokenDoc.data().points;
                try {
                    await runTransaction(db, async (tx) => {
                        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                        const uDoc = await tx.get(userRef);
                        const cur = uDoc.exists() ? (uDoc.data().points || 0) : 0;
                        const tot = uDoc.exists() ? (uDoc.data().totalPointsEarned || 0) : 0;
                        tx.set(userRef, { points: cur + pts, totalPointsEarned: tot + pts }, { merge: true });
                        tx.update(tokenRef, { status: 'used', usedBy: user.uid, usedAt: serverTimestamp() });
                        tx.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), {
                            userId: user.uid, amount: pts, reason: 'รับแต้มพิเศษผ่าน QR', type: 'earn', timestamp: serverTimestamp()
                        });
                    });
                    showMsg(`ขอแสดงความยินดี! คุณได้รับ ${pts} แต้มสะสม`);
                } catch (e) { showMsg("Failed to process points", "error"); }
            } else showMsg("รหัส QR นี้ถูกใช้งานแล้วหรือหมดอายุ", "error");
        };

        window.handleRedeemReward = async (rid) => {
            const reward = state.rewards.find(r => r.id === rid);
            if (!reward || !state.userData || state.userData.points < reward.points) return showMsg("แต้มสะสมไม่เพียงพอ", "error");
            try {
                await runTransaction(db, async (tx) => {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', state.user.uid);
                    const userDoc = await tx.get(userRef);
                    if (userDoc.data().points < reward.points) throw new Error("Insufficient points");
                    tx.update(userRef, { points: userDoc.data().points - reward.points });
                    const couponRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'coupons'));
                    tx.set(couponRef, {
                        userId: state.user.uid, rewardName: reward.name, status: 'active',
                        code: Math.random().toString(36).substring(7).toUpperCase(), timestamp: serverTimestamp()
                    });
                    tx.set(doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), {
                        userId: state.user.uid, amount: -reward.points, reason: `แลกรางวัล: ${reward.name}`, type: 'redeem', timestamp: serverTimestamp()
                    });
                });
                showMsg("แลกรางวัลสำเร็จ! ตรวจสอบที่ Wallet");
                state.view = 'coupons'; window.updateUI();
            } catch (e) { showMsg(e.message, "error"); }
        };

        window.switchRole = (r) => { state.role = r; state.view = r === 'admin' ? 'admin_report' : 'dashboard'; window.updateUI(); };
        window.switchView = (v) => { state.view = v; window.updateUI(); };

        // --- Initialization ---

        onAuthStateChanged(auth, (u) => {
            const loader = document.getElementById('loading-screen');
            if (loader) loader.classList.add('hidden');
            if (u) {
                state.user = u;
                startSync(u);
            } else {
                state.user = null;
                state.userData = null;
                window.updateUI();
            }
        });

        window.addEventListener('DOMContentLoaded', () => { setTimeout(refreshIcons, 500); });
    </script>
</body>
</html>
